const input = `....#..OO.O..OO..O...#....OO....#........#..#..OOO..#.....#..#.O#O.#...#......#..O......O....O#.#O.#
.O.#.#.O.O.OO...O..O...O.O.OO.....O.....#...#..O#O....OO##.O...O..#........O......O.O#.....O##O.#.O#
O.O#.....#.O#OOO..#O..#OO....###.#...#.O#....O..O...O###.......O...........O...OO.........O.....#.#.
.O.O...O#O##.#.O.#..OOOOO##......##O....O.........#.......#.#.##.O.......O.......#...O.O....#..O....
......#..#.##.OO.##..#..#OO.O#.#.O..........O.......#..O.O.O........O...O...##.O.O.#O........O.#OO..
......##.O.....#.O..O##.OO.##O#..O.OO......O.OO..O..O#.....O..O.....O#O...........#.O.##..OO..O....O
.....#.....O.O.#.##.....#.#..#.#.O#..##O#....#O..#.......#.O#OOOO...O...OO..O..O..O.#O.#..O.O..O.##.
......#......O##.#..#..O#............OOO............O.......O...O..OO.....#OOO.#O#....#...O........#
....#........O..O..O.##...O...#O...#.O.........O.O...#.OO#OO..OO.OO.....O#........#.#O..O.#........#
..O#.O#....O......O#.#.O#..#...#..O#....OO....O...OO.O..O......O.....O...O##OO........#...OO#..##.O.
.O#.O#..#..#O..O..O.##.O.O#.O.OOO.O.#O....O......OOO.#.....O.........#..#..O.....O..OO.#......OO..#.
...OOO.#OO#....#.O.#..O...O....#....O...O..O.OO#.O...O....O#.#.O...........#...#.O...#...OO#.O......
.O.#.O........#.....O..#.O#...O.#....#...O.......O.OO.OO#O..#..O..#.O...#.#....OO..O.O#..#.O.OO##...
.O...OO..#.#.OO#O....O.O.....OO...#O......OO........O.O......#.#.#O#...O..OOO#....##..O.##....#....#
...O...OO.O.#O.O..##.O.OO...#..O....O..O#.....#O.OO.......O.#........OO.........#..O.#...O#.O.......
O..#.O....O..#..............O.....##.....O.#.....#...........O.#.O...O.....##....O..O..#.O.#O##..O..
...O...O..O...O#..O#.OO#..O........#....#.O........#....#.....O...O.OO..O....#.##...O..#.O##..O..O..
..OO...O...O..O#.O#O...#.##.#...#..OO.O.#.#..O....O..#O.O.....O...#.#.......O...####.....#.......#..
.#O...O.O.......OO##...#.......#O.#..#OO...O......O...O#..#.....O#...O..O...........OOO.O...........
#....O.O.O........O.O#...#....O.O.........#..#.#.O.O..O.O......#.O.OOO.O...#O..OO..O#...O....#.O..#.
O.......#..O.......O..O..#.#O.O.....O#....O....O.O#..OO.#...O.#..O...#.O#...#..#.O.......#...O.###..
.OO#...##.O.OO#..#O#O...O..#.O.O....OOO#.O.#O.OO.#O...O...##O..##....OO#...O.#.........##..#.O....#.
......#...O.#...#O....O..O...#O.O....#O....#OOO.#....O.O.##..O..O....O........O.....#....O##.....O..
O.O...O#.#O......#O...#......O..O..#....#...#.O#.O.O..#......#....#......O.#.OO..#..O...O.....#O#.OO
#...O....O......O...#....#O.O..O.#......O#..##..#O#.#..O...O#..O..O##.OOO...#.OO..OO.#.#..##O.OO....
O.....O...#........#.O....OOOO....O............#..O...O....#..O.....#..O....O...#.......OO....O.#O..
#.O...#....#....#...#...OO...#O#..##..O...#.....OO....O..##...#..........#.....##OO.#...#.O.OO.#..O.
#O#O#.###.......OOO.#....O....##.O...#.#....O...#.O#.......#...#O..O.O..O#..#...O#.#O..OO...#OO.#.O#
.#O...O.........O...O.#O#O#.O.......##..##..##.O.#.#.O..OO.#.OO...OOO..#.O...O...#O..O.O#..#O#.OO..#
.#..#O...O..O..OO#.#.O..##.......#O.####..#O...OO#O...O........O...OO...OO..O......#..O.......O#.O..
.....#O#.#....OO.O.....O...###O...#.#........#...O..O....O##O#...###....O......O...O#..#..O...O.#.##
..O...#..#..O..#.OO..O......O#OO....O...O..#..........##..O#.....#.....#.OO#.#O...O#..O#...#.#.##...
..O...#...O###......O.O..O.#.O#..........O.......#O...#.##..O....O.O...#.#....O..O.#...#.O.#O.......
..#.#..#O#.....#......O...##OO.O...#..#O#O..##.O....O##....OO....#....#..O.#........OO..##.O.....OO.
O..#O.#..#.#...O.OO...OO...#.O#.#.O.O..#.........#....O...#.O..O#.....O......O...##.......#.##OO.O..
..O.OO..O..#.....#.O#...#.O..OO..OO...OO..O..#O#........O.#.O.#.O...O#O........O.....O#..#.....O...#
..O...OO.#.#O.OO.O##.##.O.O#O#.OO......OOOO.#........#.....O...#...#.##..#........#.OO..#.O.........
..##.#OO#..O#.#.#....OO.O..............O..#....#.#.OO.O..O..OO..O.#..O.....O....#.....##...O.#O..O..
..O.##..#..O...O....O..#........O.#..#.#.O......OO#OO.OO..OO.O###..#....O#.....#O..#....#OO#...#..O.
.O....O.....#O.#.O...O..#.#....###......O...OO###.O....#.#O..O#..##OO...#..O.........O#...O.....O...
O.OOO.O.#OO..#.......OOO..OO.#........O.O...OO......O....O#.O.O.....O......##....#......O....O...#..
..##..#...O....O..#.#..#OO..O..............O.O....#....#OO...#.#.OO##O...OO.O#O....##.OO....#..##.#O
...O....O#.#OO.O...#.O.##...#..O.#..#O.OO#.....O.O..O.....#....O#O....#.O.O..OO...O#O.O......###.O..
...O.O.#.............O.....##OOOO....O...O...#..O......#.##.#O...O#....#..O##.O....#O.O..#OOO....#..
.##OO..O...O.O.O....#.......O.#..#...OO...#..#..O.#.O.......O....O.....O.O.#.OO#O...#OO.O....#.#O...
...O.#OOO#.O.#...OOO......O..#.##OOO......O..OO.##.##....##.#..OO....O..O..............#...OOO......
........#..OOO.#.#...O.#..##.O#.O##.O.##.##.#..O#O.O#......#..#O.#....OO............#...###.OOO....#
#.O.O.....O...........OO...#OOO#..###...#.O#.#.....O..#..#.#.OO......#....O#.....#.O....#O#.OO.O..O.
O...........#..OO...OO...O..O.O##.....#....O##O.O.....O#..OO#.#O...#...OO..OO.......#O.#.#OO..#O###.
O...O.OO........#...##OO.........O.#....O.......#....#.#...#..#O.#...#..............#...#........O..
.#O....O.O....#...O##.#..O..OO#..#............#O...........O.OO#..##......O...O..#........#..#......
...............#.........#O..#....O..##.O......#....#.OO.#.#.O.O.OO....O.....OOO...........O.#..O..O
......O.#O..........O#O.#..O#.O#.......#.O...O...#.....O.....#..O...#..#..O...##O#..O#.O...#.OOO..O.
##O#...#..O#........#O.....O...#.#OO#O...O.##..OO..O....OO.O.#...O......O..#...#.O.#..##OO....O..O.#
........O......#.OO..OO.OOO.O...O.OO.....O..#..OO#O.O....O......O.#..OO..O#O..#.O#..#....O..O..#.#..
##..OOO.#OOO..O.O.O..O.#..O..O#..OOO.#..OO..OO..#.#.OOO...##..O#..O.#..#.#O....O..........#....O..OO
.......#.....O......O#O...##.....###...#O...#....#.#....O....O..O.O..O...#OO...#O..OO.....O.#..O....
O.#...O..#.....O..#..O....O#.....#..#.#..###....O.OO...#O..#O#.##..O.#...O.##O....OO.O...O#.O..O..#.
....#.O..#O.....O..OO#OOO#....#...#.#..#.#.....O....O..O....#....O#....O........O..O#.#.#.###O.....O
.....#O...#.#....O.....###...O....#.#...O#..O..##...O.O....#..O#.#...O.OO..#OO.....O...#..OOO....O..
#O...O.........#...#.OO....O.....#....##.#..#..##O.OO#O...O#O.....#..O...O...###.O#....#OO.##O.#O...
O..OOO..#O.O.O#..O..O.O.##..O..OO#O....O....#..OO#.OO.#.O...O.....O.O..##...#....#...O....O........O
...OO.O.....#..#.#....O...OO...#O......O.#..O#..O..O.......O.O....#.O....O.##.....OO#..#..O#.OO#O...
..........OO....#..#O.O..#....O#.#.....#...#...OO...#..O.###O...##.##..#.....#.#..O.O..O...###O.....
O..#...OO..O#....O...#O.....O....#....#..#O...#.O#..#..O...O#O.#O....O#O....O#..O.#.#.#..O.....O...O
.O.O...O.......OO..O...#......OO.#.#.#....#..#....#O.........#OO..O...#..O..O#.#..O..##..O.#O..#..O.
.#.O..O#..O..O#O.O...O#.....O..O..#..#...OO#...........#.O.OO...#..O.#.....#........#O.#.O....#O.O..
.O.....O..O...O..O......O#.O..O...........##..O.#.O.O.O.OOO....#.O..#O.#.##.......O#.#.....##...#O..
.O.O....#..#.#O....O.#......O.#.O#......O##..O....#.#...#.#.OO.......#OO#.##OO.....O.#O....OO.......
#O#....OO...O......O....OO#O.....O.#.O.....#.O......O..OO..O..OOO.O..#.O#..#..#.....O.O..#.O...#O.##
.......O.#O..#.#.....#.O.#..O..OOOO.#.O.O#...##.#...O.#OO...##.....#..O.O...#.....O.......#O.O#O...#
#O..#.#..OO.O.O...#.........#O.O#.......O#..#O.O##.#...O.##O.O..#.O......OOO.O....#...O.O...#......#
..O##O.O#.O...O.......O..#...##..O.#.O.OO.OO#.....O.#..............O.O#.##.O.O....#..#...O.....#..##
..............O.........#.##......#....##...#...O.O##O.O..##..O.....O#....O.#.....O..##..#..OO....##
#..#......O.O.O..O..O...#.#.#.OO..O#.O..O##OO#...#O...O.O.................#O.....#O.O#O....#......OO
..O#O#......O..#O......#.........O#O.#.O.....O.#.....O..O..O.##....#....OO....##..O.O.....O...O...O#
..O.O...O....OO......O....O..O.#O.O........OO......O#...OO##.........#.#...#.#......##O.##O....O.O#.
..O...#OO...O........O.O.....#.O..###O..#.....O.......#.....O...#O.#.....#....##..#....O.##.........
..#.#O.......O#..........#.#..#...O.....O.OO#..O...O.#....OO.O.OO....O..O.O#.....#..O.....#O..O..#O#
OO..O##..O.O...#.O..O..#....O..O....O..##.#..#O.O.......#.....O#..O.O.OOO..OOO#O##.#..#O.......#....
...O#.O..#.....OO.#O.O#O.O.O##..OO..O......O..##.....O....#.##....O..#.O....OO....O.#OO..O...#..O#..
O...OOO...#.O#..O#.O.##.#O.O..OOO..O...OO#OOO...O....#..O#...OO#.O..#.....O#.O...#..........OO#.#.##
...OO.#O#....O#...#.#......O....O#........O#...#O#...#...O.....#.OO#...##.OO.OO...#..O.O.....O..O...
.##..O..#O#O...#O.O..O#....#..#.......#....#.##.......#...##.O#OO......O#O.....O#.O.##...O.....OOOOO
.OO.#.O#....OO.#OO.#O.O.......O.#......#.#O#.....O......##..O#O#O...#....O.O...#...O#....O...#.O....
.O##.O..O...O.....O#......OO.O..##...........##..#O...#...O#O.O...O#...###..#.O.O#O.#O..#......#.OO.
O.OO#..O..OO.O...#OO.#.OO.#...#.#...O...O..O#OOO..OO..O......O............O.....O#..O...#OO.O.#O#OO#
O##O......#..#...#.##O#.O.......#O#.O.............O.......#..O...#.OOO..O..O..OO#O#.O##..#O.#....OO#
.....OO#.O..O..OOO.O..OO.........O#...#.....O.....#..#..O....#O#.O....O....OO..#...OO.O.O#...#.O....
...#....#......#...O#O....O##.OO..#.O#OO#.OO..#.##..OO..#..O#..O......O......OO#..O.O..........O....
...O...#...OOOOO......O...#...#.............O#O..OO...O.#...O.O..#O.OO..O.O.O...O.......#.....O.##..
....O.#...O..#...#...O.......#....#..O.O..#.#...#..O.....O#O.....O...O.........#OO.O.#...#.......O..
.#.O...O.#.#O.O.#..##..#O....#OO...OO.#..O#O.OO....#O#OO...#.O......#....#...O....#.....O..#.....##.
..#.O.OOO#O#.OO.O....#O.........O.OO.#.#.#...O#O........O..#...O....O.O#.O...#....#.OOO.#..##...#.O.
....#O#O#O#.#.#.#O.....#..O..##O........##.O.......O.O#.##O..O..O......#OO.O.#.OOO...O..#..O.....O..
#.O...O.#.#OO..OO.O.....O...OOO....##.O...#O....O...O.#O.##.....O#...O.OO.#.....O....O.O..O.O......O
..OO#......O.....O......O...#.........#.OO....OO......O...#....#OOO...O.O.OO.....#..O...OO....OOO#O#
.O...#.#.O...#..........#.O..O#.....O..##..O....O..#..#....O..O.O.OO#.O...O.#.O....#........###..OO.
....O.#....O...O.O..#OO##......#.#O.........OO......O#.O.#..OOO.#...OO...#O##.#.O......#...O...O....
#.O..O..#..O#.#....O...#...O#O#O...OO.OO...##....#..OO#...#...O.#.#O#..O..........#O.O..O...OOO.#...`;

const moves: [number, number][] = [
  [0, -1],
  [-1, 0],
  [0, 1],
  [1, 0],
];
const cache: Record<string, Record<string, string>> = {};
let state = input;

for (let i = 0; i < 1000000000; i++) {
  for (let n = 0; n < moves.length; n++) {
    const [dx, dy] = moves[n];
    const move = `${dx}${dy}`;

    if (cache[state]?.[move]) {
      state = cache[state][move];
      continue;
    }

    const matrix = state.split('\n').map((line) => line.split(''));
  
    for (let y = dy > 0 ? matrix.length - 1 : 0; dy > 0 ? y >= 0 : y < matrix.length; y += dy > 0 ? -1 : 1) {
      for (let x = dx > 0 ? matrix[0].length - 1 : 0; dx > 0 ? x >= 0 : x < matrix[0].length; x += dx > 0 ? -1 : 1) {
        const char = matrix[y][x];
  
        if (char === 'O') {
          const next = [x, y];
  
          while (true) {
            if (matrix[next[1] + dy]?.[next[0] + dx] === '.') {
              next[0] = next[0] + dx;
              next[1] = next[1] + dy;
            } else {
              break;
            }
          }
  
          matrix[y][x] = '.';
          matrix[next[1]][next[0]] = 'O';
        }
      }
    }

    if (!cache[state]) {
      cache[state] = {};
    }

    state = cache[state][move] = matrix.map((line) => line.join('')).join('\n');
  }
}

let value = 0;

console.log(state.split('\n').reduceRight((acc, line) => {
  value++;

  return acc + (line.replace(/[^O]/g, '').length * value);
}, 0));

// Answer: 102829
